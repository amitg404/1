<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Drive Hub v9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .poster-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; }
        .poster-card:hover { transform: scale(1.05); box-shadow: 0 0 15px rgba(239, 68, 68, 0.3); }
        .carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 20px; }
        .carousel > div { scroll-snap-align: start; flex-shrink: 0; }
        .modal-bg { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }

        /* Animation Classes */
        .view { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal-view { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out; }
        .view-enter-active, .modal-enter-active, .view-leave, .modal-leave { opacity: 1; transform: none; }
        .view-enter, .view-leave-active { opacity: 0; transform: scale(0.98); }
        .modal-enter, .modal-leave-active { opacity: 0; }
        .modal-enter .modal-content, .modal-leave-active .modal-content { opacity: 0; transform: translateY(20px); }
        .modal-leave .modal-content { opacity: 1; transform: translateY(0); }

        /* New UI Elements */
        .score-dial {
            width: 70px; height: 70px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: radial-gradient(closest-side, #081c22 85%, transparent 86%),
                        conic-gradient(var(--score-color, #ef4444) calc(var(--score, 0) * 1%), #374151 0);
        }
        .backdrop-carousel { scrollbar-width: none; } /* Hide scrollbar for Firefox */
        .backdrop-carousel::-webkit-scrollbar { display: none; } /* Hide scrollbar for Chrome/Safari */
        @keyframes kenburns {
            0% { transform: scale(1) translate(0, 0); }
            100% { transform: scale(1.15) translate(2%, -2%); }
        }
        .backdrop-img { animation: kenburns 40s ease-in-out infinite alternate; }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="app">
        <div id="loadingScreen" class="min-h-screen flex items-center justify-center p-4">
            <div id="credentialsBox" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8 hidden">
                <h1 class="text-3xl font-bold text-center mb-2 text-red-500">Super Drive Hub</h1>
                <p class="text-center text-gray-400 mb-8">Enter your API credentials to begin.</p>
                <div class="space-y-4">
                    <div><label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">Google API Key</label><input type="password" id="apiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none"></div>
                    <div><label for="clientId" class="block text-sm font-medium text-gray-300 mb-1">Google Client ID</label><input type="password" id="clientId" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none"></div>
                    <div><label for="tmdbApiKey" class="block text-sm font-medium text-gray-300 mb-1">TMDb API Key</label><input type="password" id="tmdbApiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none"></div>
                </div>
                <button id="authButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-8 transition-colors duration-200">Connect to Google Drive</button>
            </div>
             <div id="loadingIndicator" class="text-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto"></div><p id="loadingStatus" class="mt-4 text-lg">Initializing...</p></div>
        </div>

        <div id="mainHub" class="hidden p-4 sm:p-6 md:p-8 view">
             <div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-bold text-red-500">Browse</h1><button id="logoutButton" class="text-gray-400 hover:text-white transition-colors duration-200">Logout</button></div>
             <div id="hubContent"></div>
             <div id="scanButtonContainer" class="text-center my-8 hidden"><button id="scanButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Scan Google Drive for Media</button><p class="text-sm text-gray-400 mt-2">Required for first-time setup or to find new content.</p></div>
        </div>

        <div id="detailsModal" class="hidden fixed inset-0 z-40 overflow-y-auto modal-view">
            <div class="fixed inset-0 bg-black bg-opacity-75 modal-bg"></div>
            <div id="detailsContentWrapper" class="relative min-h-screen modal-content"></div>
        </div>
        
        <div id="gridView" class="hidden fixed inset-0 z-30 bg-gray-900 overflow-y-auto view">
            <div class="p-4 sm:p-6 md:p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="gridTitle" class="text-3xl font-bold text-red-500"></h2>
                    <button id="closeGridBtn" class="bg-gray-800 hover:bg-gray-700 py-2 px-4 rounded-lg">&larr; Back to Browse</button>
                </div>
                <div id="gridContent" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 sm:gap-6"></div>
            </div>
        </div>
    </div>
    
    <script>
        // --- CONFIG, STATE & DOM ---
        const config = {
            DRIVE_API_KEY_STORAGE: 'superdrivehub_v9_google_api_key', DRIVE_CLIENT_ID_STORAGE: 'superdrivehub_v9_google_client_id', TMDB_API_KEY_STORAGE: 'superdrivehub_v9_tmdb_api_key', LIBRARY_STORAGE: 'superdrivehub_v9_library_cache', CONTINUE_WATCHING_STORAGE: 'superdrivehub_v9_continue_watching', TMDB_BASE_URL: 'https://api.themoviedb.org/3', TMDB_IMG_URL: 'https://image.tmdb.org/t/p/w500', MAIN_FOLDER_NAME: 'Entertainment'
        };
        let state = { library: { movies: [], filmSeries: [], tvSeries: [] }, continueWatching: [], activeDetailItem: null, accessToken: null };
        const $ = (selector) => document.getElementById(selector);
        
        // --- HELPER FUNCTIONS ---
        // MOVED this function to the top to fix the ReferenceError
        function updateStatus(message) {
            $('loadingStatus').innerText = message;
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            $('apiKey').value = localStorage.getItem(config.DRIVE_API_KEY_STORAGE) || '';
            $('clientId').value = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE) || '';
            $('tmdbApiKey').value = localStorage.getItem(config.TMDB_API_KEY_STORAGE) || '';
            const cachedLibrary = localStorage.getItem(config.LIBRARY_STORAGE);
            if (cachedLibrary) state.library = JSON.parse(cachedLibrary);
            const continueWatchingData = localStorage.getItem(config.CONTINUE_WATCHING_STORAGE);
            if (continueWatchingData) state.continueWatching = JSON.parse(continueWatchingData);
            window.addEventListener('popstate', handlePopState);
            handlePopState();
            handleRedirect();
        };

        // --- GOOGLE AUTH & API ---
        function handleRedirect() {
            const fragment = new URLSearchParams(window.location.hash.substring(1));
            const token = fragment.get('access_token');
            if (token) {
                state.accessToken = token;
                gapi.load('client', () => {
                    gapi.client.setToken({ access_token: state.accessToken });
                    window.history.replaceState({}, document.title, window.location.pathname);
                    initializeGapiClient();
                });
            } else if (localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE)) {
                showCredentialsScreen();
            } else {
                showCredentialsScreen();
            }
        }
        async function initializeGapiClient() {
            try {
                updateStatus("Initializing Drive API...");
                await gapi.client.init({ apiKey: localStorage.getItem(config.DRIVE_API_KEY_STORAGE), discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'] });
                switchToMainHub();
            } catch (error) {
                console.error("GAPI client initialization error:", error);
                alert("Failed to initialize Google Drive API. Please check your API Key.");
                showCredentialsScreen();
            }
        }
        function redirectToGoogleLogin() {
            const CLIENT_ID = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE);
            const REDIRECT_URI = window.location.href.split('#')[0];
            const SCOPE = 'https://www.googleapis.com/auth/drive.readonly';
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${SCOPE}&response_type=token`;
            window.location.href = authUrl;
        }

        // --- UI TRANSITIONS & NAVIGATION ---
        function showCredentialsScreen() { /* Unchanged */ }
        function switchToMainHub() { /* Unchanged */ }
        function handlePopState() { /* Unchanged */ }

        // --- LIBRARY SCANNING ---
        async function startLibraryScan() { /* Unchanged */ }
        async function findFolderId(name) { /* Unchanged */ }
        async function listItemsInFolder(folderId, query = "") { /* Unchanged */ }
        async function processMovieFolder(folderId) { /* Unchanged */ }
        async function processSeriesFolder(folderId, type) { /* Unchanged */ }

        // --- TMDb API & METADATA ---
        async function searchTMDb(title, type, year = null) {
            const tmdbApiKey = localStorage.getItem(config.TMDB_API_KEY_STORAGE);
            const cleanedTitle = title.replace(/\(.*\)|\[.*\]/g, "").trim();
            let url = `${config.TMDB_BASE_URL}/search/${type}?api_key=${tmdbApiKey}&query=${encodeURIComponent(cleanedTitle)}`;
            if (year) url += `&primary_release_year=${year}`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return data.results?.[0]; // Return the whole first result object
            } catch (error) { console.error(`TMDb search failed for ${title}:`, error); }
            return null;
        }
        async function getTMDbDetails(tmdbId, type) {
            const tmdbApiKey = localStorage.getItem(config.TMDB_API_KEY_STORAGE);
            if (!tmdbId) return null;
            const url = `${config.TMDB_BASE_URL}/${type}/${tmdbId}?api_key=${tmdbApiKey}&append_to_response=credits,images&include_image_language=en,null`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                return {
                    poster: data.poster_path ? `${config.TMDB_IMG_URL}${data.poster_path}` : null,
                    backdrop: data.backdrop_path ? `${config.TMDB_IMG_URL.replace("w500","w1280")}${data.backdrop_path}` : null,
                    overview: data.overview,
                    release_date: data.release_date || data.first_air_date,
                    vote_average: data.vote_average,
                    credits: data.credits,
                    images: data.images,
                    status: data.status,
                    original_language: data.original_language,
                    budget: data.budget,
                    revenue: data.revenue,
                    tmdbId: data.id,
                    name: data.name || data.title
                };
            } catch (error) { console.error(`TMDb details fetch failed for ID ${tmdbId}:`, error); }
            return null;
        }
        async function handleMetadataCorrection() { /* Updated Below */ }
        
        // --- UI RENDERING ---
        function renderMainHub() { /* Unchanged */ }
        function createCarousel(title, items, type) { /* Unchanged */ }
        function showGridView(type, title, noHistory) { /* Unchanged */ }
        function hideGridView(noHistory) { /* Unchanged */ }

        function showDetails(item, context, noHistory) {
            state.activeDetailItem = { item, context };
            const year = item.release_date ? `(${item.release_date.substring(0, 4)})` : '';
            const score = item.vote_average ? Math.round(item.vote_average * 10) : 0;
            const scoreColor = score >= 70 ? '#22c55e' : score >= 40 ? '#eab308' : '#ef4444';
            
            const formatCurrency = (num) => num ? `$${num.toLocaleString()}` : 'N/A';
            const formatLang = (code) => code ? new Intl.DisplayNames(['en'], {type: 'language'}).of(code) : 'N/A';

            let backdropHtml = item.images?.backdrops.slice(0, 10).map(img => 
                `<div class="w-full h-full absolute inset-0 flex-shrink-0"><img src="${config.TMDB_IMG_URL.replace("w500","w1280")}${img.file_path}" class="backdrop-img w-full h-full object-cover"></div>`
            ).join('') || `<div class="w-full h-full absolute inset-0 bg-cover bg-center" style="background-image: url('${item.backdrop || ''}');"></div>`;
            
            let castHtml = item.credits?.cast.slice(0, 6).map(person => `
                <div class="bg-gray-800/50 rounded-lg p-2 flex items-center space-x-3">
                    <img src="${person.profile_path ? config.TMDB_IMG_URL + person.profile_path : 'https://placehold.co/200x300/1f2937/374151?text=?'}" class="w-12 h-12 rounded-full object-cover">
                    <div>
                        <p class="font-bold text-sm">${person.name}</p>
                        <p class="text-xs text-gray-400">${person.character}</p>
                    </div>
                </div>`).join('') || '';

            let contentHtml = `
                <div class="absolute top-4 left-4 z-20 flex space-x-2">
                    <button onclick="history.back()" class="bg-gray-800/50 hover:bg-gray-700/70 py-2 px-4 rounded-lg">&larr; Back</button>
                    <button onclick="handleMetadataCorrection()" class="bg-blue-600/80 hover:bg-blue-500/90 py-2 px-4 rounded-lg">Fix Match</button>
                </div>
                <div class="h-[60vh] w-full relative overflow-hidden">
                    <div class="w-full h-full flex backdrop-carousel">${backdropHtml}</div>
                    <div class="absolute inset-0 bg-gradient-to-t from-gray-900 via-gray-900/70 to-transparent"></div>
                </div>
                <div class="p-4 sm:p-8 -mt-48 relative z-10 flex flex-col md:flex-row gap-8">
                    <div class="w-48 md:w-64 flex-shrink-0">
                        <img src="${item.poster || ''}" class="rounded-lg w-full aspect-[2/3] object-cover bg-gray-800 shadow-2xl">
                    </div>
                    <div class="flex-grow pt-16">
                        <h1 class="text-4xl lg:text-5xl font-bold">${item.name} <span class="text-3xl font-light text-gray-400">${year}</span></h1>
                        <div class="flex items-center gap-4 mt-4">
                            <div class="score-dial" style="--score: ${score}; --score-color: ${scoreColor};">
                                <span class="font-bold text-xl">${score}<span class="text-xs">%</span></span>
                            </div>
                            <span class="font-semibold">User Score</span>
                            ${item.type === 'movie' ? `<button onclick='openPlayer(${JSON.stringify(item)})' class="bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold">Play Movie</button>` : ''}
                        </div>
                        <p class="mt-4 max-w-3xl text-gray-300">${item.overview}</p>
                    </div>
                </div>
                <div class="px-4 sm:px-8 pb-8 grid grid-cols-1 md:grid-cols-12 gap-8">
                    <div class="md:col-span-8">
                        ${castHtml ? `<h3 class="text-2xl font-bold mb-4">Top Billed Cast</h3><div class="grid grid-cols-2 lg:grid-cols-3 gap-4">${castHtml}</div>` : ''}
                        ${item.type !== 'movie' ? item.seasons.map((season, seasonIndex) => `
                            <h3 class="text-2xl font-bold mt-8 mb-4">${season.name}</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${season.episodes.map((episode, episodeIndex) => {
                                const epContext = { ...item, driveId: episode.driveId, name: episode.name, seasonIndex, episodeIndex };
                                return `<div onclick='openPlayer(${JSON.stringify(epContext)})' class="bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700"><p class="font-semibold truncate">${episode.name}</p></div>`;
                            }).join('')}
                            </div>`).join('') : ''
                        }
                    </div>
                    <div class="md:col-span-4">
                        <h3 class="text-2xl font-bold mb-4">Info</h3>
                        <div class="space-y-3 bg-gray-800/50 p-4 rounded-lg">
                            <div><strong class="block font-semibold">Status</strong><span class="text-gray-300">${item.status || 'N/A'}</span></div>
                            <div><strong class="block font-semibold">Original Language</strong><span class="text-gray-300">${formatLang(item.original_language)}</span></div>
                            <div><strong class="block font-semibold">Budget</strong><span class="text-gray-300">${formatCurrency(item.budget)}</span></div>
                            <div><strong class="block font-semibold">Revenue</strong><span class="text-gray-300">${formatCurrency(item.revenue)}</span></div>
                        </div>
                    </div>
                </div>
            `;
            
            $('detailsContentWrapper').innerHTML = contentHtml;
            const modal = $('detailsModal');
            modal.style.display = 'block';
            modal.classList.remove('modal-leave-active');
            modal.classList.add('modal-enter-active');
            if (!noHistory) history.pushState({ view: 'details', tmdbId: item.tmdbId }, '', `#details/${item.tmdbId}`);
        }
        function closeDetails(noHistory) { /* Unchanged */ }
        function findAndShowDetails(tmdbId) { /* Unchanged */ }

        // --- PLAYER & STATE MANAGEMENT ---
        function openPlayer(itemContext) { /* Unchanged */ }
        function findLibraryItem(itemToFind) { /* Unchanged */ }
        function updateContinueWatching(item) { /* Unchanged */ }

        // --- EVENT LISTENERS ---
        $('authButton').addEventListener('click', () => { /* Unchanged */ });
        $('logoutButton').addEventListener('click', () => { /* Unchanged */ });
        $('scanButton').addEventListener('click', startLibraryScan);
        $('closeGridBtn').addEventListener('click', () => history.back());
        document.addEventListener('click', (e) => { if (e.target.matches('.view-all-btn')) { e.preventDefault(); showGridView(e.target.dataset.type, e.target.dataset.title); }});
        
        // --- ALL FUNCTIONS (Formatted for readability) ---
        function showCredentialsScreen() {
            $('loadingIndicator').style.display = 'none';
            $('credentialsBox').style.display = 'block';
        }
        function switchToMainHub() {
            $('loadingScreen').style.display = 'none';
            $('mainHub').style.display = 'block';
            if (state.library.movies.length === 0 && state.library.tvSeries.length === 0 && state.library.filmSeries.length === 0) {
                $('scanButtonContainer').style.display = 'block';
            } else {
                $('scanButtonContainer').style.display = 'none';
                renderMainHub();
            }
        }
        function handlePopState() {
            const hash = window.location.hash;
            if (hash.startsWith('#details/')) {
                if ($('detailsModal').style.display !== 'block') {
                    const tmdbId = hash.split('/')[1];
                    findAndShowDetails(tmdbId);
                }
            } else if (hash.startsWith('#grid/')) {
                if ($('gridView').style.display !== 'block') {
                    const type = hash.split('/')[1];
                    showGridView(type);
                }
            } else {
                closeDetails(true);
                hideGridView(true);
            }
        }
        async function startLibraryScan() {
            const scanBtnContainer = $('scanButtonContainer');
            const loadingScr = $('loadingScreen');
            const loadingInd = $('loadingIndicator');
            scanBtnContainer.style.display = 'none';
            loadingScr.style.display = 'flex';
            loadingInd.style.display = 'block';
            try {
                updateStatus(`Finding '${config.MAIN_FOLDER_NAME}' folder...`);
                const mainFolderId = await findFolderId(config.MAIN_FOLDER_NAME);
                if (!mainFolderId) {
                    updateStatus(`Error: Main folder '${config.MAIN_FOLDER_NAME}' not found.`);
                    setTimeout(() => { switchToMainHub(); scanBtnContainer.style.display = 'block'; }, 3000);
                    return;
                }
                updateStatus("Scanning library structure...");
                const subFolders = await listItemsInFolder(mainFolderId, "mimeType='application/vnd.google-apps.folder'");
                const newLibrary = { movies: [], filmSeries: [], tvSeries: [] };
                for (const folder of subFolders) {
                    if (folder.name.toLowerCase() === 'movies') {
                        updateStatus("Processing Movies...");
                        newLibrary.movies = await processMovieFolder(folder.id);
                    } else if (folder.name.toLowerCase() === 'film series') {
                        updateStatus("Processing Film Series...");
                        newLibrary.filmSeries = await processSeriesFolder(folder.id, 'filmSeries');
                    } else if (folder.name.toLowerCase() === 'series') {
                        updateStatus("Processing TV Series...");
                        newLibrary.tvSeries = await processSeriesFolder(folder.id, 'tvSeries');
                    }
                }
                state.library = newLibrary;
                localStorage.setItem(config.LIBRARY_STORAGE, JSON.stringify(state.library));
                switchToMainHub();
            } catch (error) {
                console.error("Library Scan Failed:", error);
                updateStatus("An error occurred during the scan. Please check console.");
                setTimeout(() => { switchToMainHub(); scanBtnContainer.style.display = 'block'; }, 3000);
            }
        }
        async function findFolderId(name) {
            const response = await gapi.client.drive.files.list({
                q: `mimeType='application/vnd.google-apps.folder' and name='${name}' and trashed=false`,
                fields: "files(id)",
                pageSize: 1
            });
            return response.result.files?.[0]?.id;
        }
        async function listItemsInFolder(folderId, query = "") {
            let items = [];
            let pageToken = null;
            const baseQuery = `'${folderId}' in parents and trashed=false`;
            const finalQuery = query ? `${baseQuery} and (${query})` : baseQuery;
            do {
                const response = await gapi.client.drive.files.list({
                    q: finalQuery,
                    fields: "nextPageToken, files(id, name)",
                    pageSize: 200,
                    pageToken: pageToken
                });
                items.push(...response.result.files);
                pageToken = response.result.nextPageToken;
            } while (pageToken);
            return items;
        }
        async function processMovieFolder(folderId) {
            const movieFolders = await listItemsInFolder(folderId, "mimeType='application/vnd.google-apps.folder'");
            const movies = [];
            for (const movieFolder of movieFolders) {
                const videoFiles = await listItemsInFolder(movieFolder.id, "mimeType contains 'video/'");
                if (videoFiles.length > 0) {
                    const searchResult = await searchTMDb(movieFolder.name, 'movie');
                    if (searchResult) {
                        const details = await getTMDbDetails(searchResult.id, 'movie');
                        movies.push({ driveId: videoFiles[0].id, name: movieFolder.name, type: 'movie', ...details });
                    }
                }
            }
            return movies;
        }
        async function processSeriesFolder(folderId, type) {
            const seriesFolders = await listItemsInFolder(folderId, "mimeType='application/vnd.google-apps.folder'");
            const seriesList = [];
            for (const seriesFolder of seriesFolders) {
                updateStatus(`Processing: ${seriesFolder.name}`);
                const searchResult = await searchTMDb(seriesFolder.name, type === 'tvSeries' ? 'tv' : 'movie');
                if (searchResult) {
                    const details = await getTMDbDetails(searchResult.id, type === 'tvSeries' ? 'tv' : 'movie');
                    const seriesItem = { name: seriesFolder.name, type: type, ...details, seasons: [] };
                    if (type === 'tvSeries') {
                        const seasonFolders = await listItemsInFolder(seriesFolder.id, "mimeType='application/vnd.google-apps.folder'");
                        seasonFolders.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
                        for (const seasonFolder of seasonFolders) {
                            const episodes = await listItemsInFolder(seasonFolder.id, "mimeType contains 'video/'");
                            episodes.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
                            seriesItem.seasons.push({ name: seasonFolder.name, episodes: episodes.map(ep => ({ name: ep.name, driveId: ep.id })) });
                        }
                    } else { // Film Series
                        const movieFolders = await listItemsInFolder(seriesFolder.id, "mimeType='application/vnd.google-apps.folder'");
                        movieFolders.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
                        const movies = [];
                        for (const movieFolder of movieFolders) {
                            const videoFiles = await listItemsInFolder(movieFolder.id, "mimeType contains 'video/'");
                            if (videoFiles.length > 0) movies.push({ name: movieFolder.name, driveId: videoFiles[0].id });
                        }
                        seriesItem.seasons.push({ name: "Movies", episodes: movies });
                    }
                    seriesList.push(seriesItem);
                }
            }
            return seriesList;
        }
        function renderMainHub() {
            const hub = $('hubContent');
            hub.innerHTML = "";
            if (state.continueWatching.length > 0) hub.appendChild(createCarousel("Continue Watching", state.continueWatching, "continue"));
            if (state.library.tvSeries.length > 0) hub.appendChild(createCarousel("TV Shows", state.library.tvSeries, "tvSeries"));
            if (state.library.movies.length > 0) hub.appendChild(createCarousel("Movies", state.library.movies, "movie"));
            if (state.library.filmSeries.length > 0) hub.appendChild(createCarousel("Film Series", state.library.filmSeries, "filmSeries"));
        }
        function createCarousel(title, items, type) {
            const section = document.createElement('div'); section.className = 'mb-8';
            section.innerHTML = `<div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${title}</h2><button class="text-sm font-semibold text-red-400 hover:text-red-300 view-all-btn" data-type="${type}" data-title="${title}">View All &gt;</button></div>`;
            const carousel = document.createElement('div'); carousel.className = 'carousel';
            items.forEach((item) => {
                const posterUrl = item.poster || 'https://placehold.co/500x750/1f2937/374151?text=No+Poster';
                const card = document.createElement('div'); card.className = 'poster-card w-40 sm:w-48 mr-4 cursor-pointer';
                card.innerHTML = `<img src="${posterUrl}" class="rounded-lg w-full aspect-[2/3] object-cover bg-gray-800"><p class="mt-2 text-sm truncate">${item.name}</p>`;
                card.addEventListener('click', () => showDetails(findLibraryItem(item) || item, { type }));
                carousel.appendChild(card);
            });
            section.appendChild(carousel);
            return section;
        }
        function showGridView(type, title, noHistory) {
            let items = type === 'continue' ? state.continueWatching : state.library[{ 'movie': 'movies', 'tvSeries': 'tvSeries', 'filmSeries': 'filmSeries' }[type]];
            if (!items) return;
            $('gridTitle').textContent = title;
            const grid = $('gridContent'); grid.innerHTML = '';
            items.forEach(item => {
                const posterUrl = item.poster || 'https://placehold.co/500x750/1f2937/374151?text=No+Poster';
                const card = document.createElement('div'); card.className = 'poster-card cursor-pointer';
                card.innerHTML = `<img src="${posterUrl}" class="rounded-lg w-full aspect-[2/3] object-cover bg-gray-800"><p class="mt-2 text-sm truncate">${item.name}</p>`;
                card.addEventListener('click', () => showDetails(findLibraryItem(item) || item, { type }));
                grid.appendChild(card);
            });
            $('mainHub').classList.add('view-leave-active');
            const gridViewEl = $('gridView');
            gridViewEl.style.display = 'block';
            gridViewEl.classList.remove('view-leave-active');
            gridViewEl.classList.add('view-enter-active');
            if (!noHistory) history.pushState({ view: 'grid', type: type }, '', `#grid/${type}`);
        }
        function hideGridView(noHistory) {
            const gridViewEl = $('gridView');
            if (gridViewEl.style.display === 'block') {
                gridViewEl.classList.add('view-leave-active');
                $('mainHub').classList.remove('view-leave-active');
                $('mainHub').classList.add('view-enter-active');
                setTimeout(() => gridViewEl.style.display = 'none', 300);
                if (!noHistory) history.pushState({ view: 'hub' }, '', window.location.pathname);
            }
        }
        function closeDetails(noHistory) {
            const modal = $('detailsModal');
            if (modal.style.display === 'block') {
                modal.classList.add('modal-leave-active');
                setTimeout(() => {
                    modal.style.display = 'none';
                    $('detailsContentWrapper').innerHTML = '';
                    state.activeDetailItem = null;
                }, 300);
                if (!noHistory && window.location.hash.startsWith('#details')) history.back();
            }
        }
        function findAndShowDetails(tmdbId) {
            for (const category of ['movies', 'tvSeries', 'filmSeries']) {
                const item = state.library[category]?.find(i => i.tmdbId == tmdbId);
                if (item) {
                    const typeKeyMap = { 'movies': 'movie', 'tvSeries': 'tvSeries', 'filmSeries': 'filmSeries' };
                    showDetails(item, { type: typeKeyMap[category] }, true);
                    break;
                }
            }
        }
        async function handleMetadataCorrection() {
            const { item, context } = state.activeDetailItem;
            const input = prompt(`Enter TMDb URL or Name (Year) for "${item.name}":\n(e.g., Iron Man (2008))`);
            if (!input) return;
            
            let newMetadata;
            const urlMatch = input.match(/(movie|tv)\/(\d+)/);
            
            try {
                if (urlMatch) {
                    const [_, type, id] = urlMatch;
                    newMetadata = await getTMDbDetails(id, type);
                } else {
                    const nameMatch = input.match(/^(.*?)\s*\((\d{4})\)?$/);
                    const searchName = nameMatch ? nameMatch[1].trim() : input;
                    const searchYear = nameMatch ? nameMatch[2] : null;
                    const searchType = context.type === 'tvSeries' ? 'tv' : 'movie';
                    const searchResult = await searchTMDb(searchName, searchType, searchYear);
                    if (!searchResult) throw new Error(`Could not find a match for "${input}"`);
                    newMetadata = await getTMDbDetails(searchResult.id, searchType);
                }

                if (!newMetadata) throw new Error("Failed to fetch details from TMDb.");

                Object.assign(item, newMetadata);
                localStorage.setItem(config.LIBRARY_STORAGE, JSON.stringify(state.library));
                showDetails(item, context);
                renderMainHub();

            } catch(error) {
                alert(error.message);
                console.error("Metadata correction error:", error);
            }
        }
        function openPlayer(itemContext) {
            updateContinueWatching(itemContext);
            const params = new URLSearchParams();
            params.set("driveId", itemContext.driveId);
            params.set("title", itemContext.name);
            params.set("accessToken", state.accessToken);
            if (itemContext.type !== 'movie') {
                params.set("seriesId", itemContext.tmdbId);
                const libraryItem = findLibraryItem(itemContext);
                if (libraryItem?.seasons) {
                    const currentSeason = libraryItem.seasons[itemContext.seasonIndex];
                    if (itemContext.episodeIndex < currentSeason.episodes.length - 1) {
                        const nextEpisode = currentSeason.episodes[itemContext.episodeIndex + 1];
                        params.set("nextDriveId", nextEpisode.driveId);
                        params.set("nextTitle", nextEpisode.name);
                    }
                }
            }
            window.open(`player.html?${params.toString()}`, "_blank");
        }
        function findLibraryItem(itemToFind) {
            if (!itemToFind || !itemToFind.type) return null;
            const typeMap = { 'movie': 'movies', 'tvSeries': 'tvSeries', 'filmSeries': 'filmSeries' };
            const category = typeMap[itemToFind.type];
            if (!category) return null;
            return state.library[category]?.find(item => item.name === itemToFind.name);
        }
        function updateContinueWatching(item) {
            let continueList = state.continueWatching;
            const driveId = item.driveId;
            continueList = continueList.filter(cwItem => cwItem.driveId !== driveId);
            continueList.unshift(item);
            if (continueList.length > 15) continueList.pop();
            state.continueWatching = continueList;
            localStorage.setItem(config.CONTINUE_WATCHING_STORAGE, JSON.stringify(state.continueWatching));
            renderMainHub();
        }

        // --- EVENT LISTENERS ---
        $('authButton').addEventListener('click', () => {
            const apiKey = $('apiKey').value.trim(); const clientId = $('clientId').value.trim(); const tmdbApiKey = $('tmdbApiKey').value.trim();
            if (apiKey && clientId && tmdbApiKey) {
                localStorage.setItem(config.DRIVE_API_KEY_STORAGE, apiKey); localStorage.setItem(config.DRIVE_CLIENT_ID_STORAGE, clientId); localStorage.setItem(config.TMDB_API_KEY_STORAGE, tmdbApiKey);
                redirectToGoogleLogin();
            } else { alert('Please enter all three API keys.'); }
        });
        $('logoutButton').addEventListener('click', () => {
            Object.values(config).forEach(key => localStorage.removeItem(key));
            Object.keys(localStorage).forEach(key => { if (key.startsWith('track_prefs_')) { localStorage.removeItem(key); } });
            window.location.href = window.location.pathname;
        });
        $('scanButton').addEventListener('click', startLibraryScan);
        $('closeGridBtn').addEventListener('click', () => history.back());
        document.addEventListener('click', (e) => {
            if (e.target.matches('.view-all-btn')) { e.preventDefault(); showGridView(e.target.dataset.type, e.target.dataset.title); }
        });
    </script>
</body>
</html>
