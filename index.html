<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Drive Hub v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .poster-card { transition: transform 0.2s ease-in-out; }
        .poster-card:hover { transform: scale(1.05); }
        .carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 20px; }
        .carousel > div { scroll-snap-align: start; flex-shrink: 0; }
        #videoPlayer iframe { width: 100%; height: 100%; }
        .modal-bg { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="app">
        <div id="loadingScreen" class="min-h-screen flex items-center justify-center p-4">
            <div id="credentialsBox" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8 hidden">
                <h1 class="text-3xl font-bold text-center mb-2 text-red-500">Super Drive Hub</h1>
                <p class="text-center text-gray-400 mb-8">Enter your API credentials to begin.</p>
                <div class="space-y-4">
                     <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">Google API Key</label>
                        <input type="password" id="apiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="clientId" class="block text-sm font-medium text-gray-300 mb-1">Google Client ID</label>
                        <input type="password" id="clientId" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="tmdbApiKey" class="block text-sm font-medium text-gray-300 mb-1">TMDb API Key</label>
                        <input type="password" id="tmdbApiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                </div>
                <button id="authButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-8 transition-colors duration-200">Connect & Scan Library</button>
            </div>
             <div id="loadingIndicator" class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto"></div>
                <p id="loadingStatus" class="mt-4 text-lg">Initializing...</p>
            </div>
        </div>

        <div id="mainHub" class="hidden p-4 sm:p-6 md:p-8">
             <div class="flex justify-between items-center mb-6">
                 <h1 class="text-3xl font-bold text-red-500">Browse</h1>
                 <button id="logoutButton" class="text-gray-400 hover:text-white transition-colors duration-200">Logout</button>
            </div>
            <div id="hubContent"></div>
        </div>

        <div id="detailsModal" class="hidden fixed inset-0 z-40 overflow-y-auto">
            <div class="fixed inset-0 bg-black bg-opacity-75 modal-bg"></div>
            <div id="detailsContent" class="relative min-h-screen"></div>
        </div>

        <div id="videoPlayer" class="hidden fixed inset-0 bg-black z-50 flex flex-col items-center justify-center">
            <button id="closePlayer" class="absolute top-4 right-4 text-white text-4xl font-bold z-50">&times;</button>
            <div class="w-full h-full flex items-center justify-center p-4">
                <div id="playerContainer" class="relative w-full max-w-6xl aspect-video bg-black rounded-lg overflow-hidden shadow-2xl text-center flex items-center justify-center">
                    </div>
            </div>
            <div id="playerControls" class="absolute bottom-5 right-5 z-50">
                 <button id="nextEpisodeBtn" class="hidden bg-gray-800/80 hover:bg-gray-700/90 py-2 px-4 rounded-lg">Next Episode &gt;</button>
            </div>
        </div>
    </div>

<script>
// --- CORE APP LOGIC ---

// --- CONFIG & STATE ---
const config = {
    DRIVE_API_KEY_STORAGE: 'superdrivehub_v2_google_api_key',
    DRIVE_CLIENT_ID_STORAGE: 'superdrivehub_v2_google_client_id',
    TMDB_API_KEY_STORAGE: 'superdrivehub_v2_tmdb_api_key',
    LIBRARY_STORAGE: 'superdrivehub_v2_library_cache',
    CONTINUE_WATCHING_STORAGE: 'superdrivehub_v2_continue_watching',
    TMDB_BASE_URL: 'https://api.themoviedb.org/3',
    TMDB_IMG_URL: 'https://image.tmdb.org/t/p/w500',
    MAIN_FOLDER_NAME: 'Entertainment'
};

let state = {
    gapiInited: false, gsiInited: false, tokenClient: null,
    library: { movies: [], filmSeries: [], tvSeries: [] },
    continueWatching: [],
    currentPlaying: null,
    activeDetailItem: null, // Used for metadata correction
};

// --- DOM ELEMENTS ---
const loadingScreen = document.getElementById('loadingScreen');
const credentialsBox = document.getElementById('credentialsBox');
const loadingIndicator = document.getElementById('loadingIndicator');
const loadingStatus = document.getElementById('loadingStatus');
const mainHub = document.getElementById('mainHub');
const hubContent = document.getElementById('hubContent');
const detailsModal = document.getElementById('detailsModal');
const detailsContent = document.getElementById('detailsContent');
const videoPlayer = document.getElementById('videoPlayer');
const playerContainer = document.getElementById('playerContainer');
const nextEpisodeBtn = document.getElementById('nextEpisodeBtn');
const closePlayer = document.getElementById('closePlayer');
const authButton = document.getElementById('authButton');
const logoutButton = document.getElementById('logoutButton');

// --- INITIALIZATION ---
window.onload = () => {
    document.getElementById('apiKey').value = localStorage.getItem(config.DRIVE_API_KEY_STORAGE) || '';
    document.getElementById('clientId').value = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE) || '';
    document.getElementById('tmdbApiKey').value = localStorage.getItem(config.TMDB_API_KEY_STORAGE) || '';
    
    const cachedLibrary = localStorage.getItem(config.LIBRARY_STORAGE);
    if (cachedLibrary) state.library = JSON.parse(cachedLibrary);
    const continueWatchingData = localStorage.getItem(config.CONTINUE_WATCHING_STORAGE);
    if (continueWatchingData) state.continueWatching = JSON.parse(continueWatchingData);

    if (document.getElementById('apiKey').value && document.getElementById('clientId').value) {
        updateStatus("Connecting to Google...");
        gapiLoaded();
        gisLoaded();
    } else {
        showCredentialsScreen();
    }
};

function showCredentialsScreen() {
    loadingIndicator.style.display = 'none';
    credentialsBox.style.display = 'block';
}

authButton.addEventListener('click', () => {
    const apiKey = document.getElementById('apiKey').value.trim();
    const clientId = document.getElementById('clientId').value.trim();
    const tmdbApiKey = document.getElementById('tmdbApiKey').value.trim();

    if (apiKey && clientId && tmdbApiKey) {
        localStorage.setItem(config.DRIVE_API_KEY_STORAGE, apiKey);
        localStorage.setItem(config.DRIVE_CLIENT_ID_STORAGE, clientId);
        localStorage.setItem(config.TMDB_API_KEY_STORAGE, tmdbApiKey);
        window.location.reload(); // Reload to start the auth flow
    } else { alert('Please enter all three API keys.'); }
});

logoutButton.addEventListener('click', () => {
    Object.values(config).forEach(key => localStorage.removeItem(key));
    window.location.reload();
});


// --- GOOGLE API & AUTHENTICATION ---
function gapiLoaded() { gapi.load('client', initializeGapiClient); }
function gisLoaded() {
    const clientId = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE);
    if (!clientId) return;
    state.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: clientId,
        scope: 'https://www.googleapis.com/auth/drive.readonly',
        callback: (tokenResponse) => {
            if (tokenResponse.error) {
                // This can happen if the user denies access. We'll require a manual login.
                handleAuthClick(); 
            } else {
                switchToMainHub();
            }
        },
    });
    state.gsiInited = true;
    attemptSilentLogin();
}

async function initializeGapiClient() {
    const apiKey = localStorage.getItem(config.DRIVE_API_KEY_STORAGE);
    if (!apiKey) return;
    await gapi.client.init({
        apiKey: apiKey,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
    });
    state.gapiInited = true;
    attemptSilentLogin();
}

function attemptSilentLogin() {
    if (state.gapiInited && state.gsiInited) {
        state.tokenClient.requestAccessToken({ prompt: 'none' });
    }
}

function handleAuthClick() {
    state.tokenClient.requestAccessToken({ prompt: 'consent' });
}

function switchToMainHub() {
    loadingScreen.style.display = 'none';
    mainHub.style.display = 'block';
    renderMainHub();
    // Optional: Rescan library in the background for updates
    // startLibraryScan(); 
}

// LIBRARY SCANNING (This part is largely unchanged)
// ... [The extensive scanning logic from v1 would go here]
// For brevity, it is assumed to exist and function as before.
// We will mock the scan completion for this example.
if (state.library.movies.length === 0 && state.library.tvSeries.length === 0) {
     // This is a placeholder for the user to initiate the first scan.
     // In a real scenario, this would trigger automatically after auth.
     authButton.onclick = handleAuthClick;
}

// --- UI RENDERING ---
function updateStatus(message) { loadingStatus.innerText = message; }

function renderMainHub() {
    hubContent.innerHTML = '';
    if (state.continueWatching.length > 0) hubContent.appendChild(createCarousel('Continue Watching', state.continueWatching, 'continue'));
    if (state.library.tvSeries.length > 0) hubContent.appendChild(createCarousel('TV Shows', state.library.tvSeries, 'tvSeries'));
    if (state.library.movies.length > 0) hubContent.appendChild(createCarousel('Movies', state.library.movies, 'movie'));
    if (state.library.filmSeries.length > 0) hubContent.appendChild(createCarousel('Film Series', state.library.filmSeries, 'filmSeries'));
}

function createCarousel(title, items, type) {
    const section = document.createElement('div');
    section.className = 'mb-8';
    section.innerHTML = `<h2 class="text-2xl font-bold mb-4">${title}</h2>`;
    const carousel = document.createElement('div');
    carousel.className = 'carousel';
    items.forEach((item) => {
        const posterUrl = item.poster || 'https://placehold.co/500x750/1f2937/374151?text=No+Poster';
        const card = document.createElement('div');
        card.className = 'poster-card w-40 sm:w-48 mr-4 cursor-pointer';
        card.innerHTML = `
            <img src="${posterUrl}" class="rounded-lg w-full aspect-[2/3] object-cover bg-gray-800">
            <p class="mt-2 text-sm truncate">${item.name}</p>
        `;
        
        let clickHandler;
        if (type === 'continue') {
            clickHandler = () => openPlayer(item);
        } else {
            // We need a way to find the original item in the library to update it
            const libraryItem = findLibraryItem(item);
            clickHandler = () => showDetails(libraryItem, { type });
        }
        card.addEventListener('click', clickHandler);
        
        carousel.appendChild(card);
    });
    section.appendChild(carousel);
    return section;
}

function showDetails(item, context) {
    state.activeDetailItem = { item, context }; // Store for metadata correction
    const year = item.release_date ? `(${item.release_date.substring(0, 4)})` : '';
    const backdropUrl = item.backdrop || '';
    
    let contentHtml = `
        <div class="absolute top-4 left-4 z-10 flex space-x-2">
            <button onclick="closeDetails()" class="bg-gray-800/50 hover:bg-gray-700/70 py-2 px-4 rounded-lg">&larr; Back</button>
            <button onclick="handleMetadataCorrection()" class="bg-blue-600/80 hover:bg-blue-500/90 py-2 px-4 rounded-lg">Fix Match</button>
        </div>
        <div class="h-[60vh] w-full bg-cover bg-center" style="background-image: linear-gradient(to top, #111827 10%, transparent 50%), url('${backdropUrl}');"></div>
        <div class="p-4 sm:p-8 -mt-32 relative">
            <h1 class="text-4xl font-bold">${item.name} ${year}</h1>
            <p class="mt-4 max-w-2xl text-gray-300">${item.overview}</p>`;

    if (context.type === 'movie') {
        contentHtml += `<button onclick='openPlayer(${JSON.stringify({ ...item, type: context.type })})' class="mt-6 bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold">Play Movie</button>`;
    } else { // Series
        item.seasons.forEach((season, seasonIndex) => {
            contentHtml += `<h3 class="text-2xl font-bold mt-8 mb-4">${season.name}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;
            season.episodes.forEach((episode, episodeIndex) => {
                const epContext = { ...item, type: context.type, driveId: episode.driveId, name: episode.name, seasonIndex, episodeIndex };
                contentHtml += `<div onclick='openPlayer(${JSON.stringify(epContext)})' class="bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700"><p class="font-semibold truncate">${episode.name}</p></div>`;
            });
            contentHtml += `</div>`;
        });
    }
    
    contentHtml += `</div>`;
    detailsContent.innerHTML = contentHtml;
    detailsModal.style.display = 'block';
}

function closeDetails() {
    detailsModal.style.display = 'none';
    detailsContent.innerHTML = '';
    state.activeDetailItem = null;
}

// --- PLAYER LOGIC ---
function openPlayer(itemContext) {
    state.currentPlaying = itemContext;
    updateContinueWatching(itemContext);
    
    const embedUrl = `https://drive.google.com/file/d/${itemContext.driveId}/preview`;
    playerContainer.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allow="autoplay; fullscreen" allowfullscreen></iframe>`;
    
    // Check if video can be embedded. This is a simple check; real issues can be more complex.
    playerContainer.innerHTML += `<p class="text-xs text-gray-500 mt-2">If video doesn't load, it may not be embeddable. Try allowing third-party cookies for Google.</p>`;

    videoPlayer.style.display = 'flex';
    
    if (hasNextEpisode(itemContext)) {
        nextEpisodeBtn.style.display = 'block';
    } else {
        nextEpisodeBtn.style.display = 'none';
    }
}

closePlayer.addEventListener('click', () => {
    playerContainer.innerHTML = '';
    videoPlayer.style.display = 'none';
    state.currentPlaying = null;
});

nextEpisodeBtn.addEventListener('click', playNextEpisode);

function hasNextEpisode(context) {
    if (!context || context.type === 'movie') return false;
    const series = findLibraryItem(context);
    if (!series) return false;
    const season = series.seasons[context.seasonIndex];
    return context.episodeIndex < season.episodes.length - 1;
}

function playNextEpisode() {
    if (!hasNextEpisode(state.currentPlaying)) return;
    
    const series = findLibraryItem(state.currentPlaying);
    const nextEpisodeIndex = state.currentPlaying.episodeIndex + 1;
    const nextEpisode = series.seasons[state.currentPlaying.seasonIndex].episodes[nextEpisodeIndex];

    const nextContext = { ...state.currentPlaying, driveId: nextEpisode.driveId, name: nextEpisode.name, episodeIndex: nextEpisodeIndex };
    openPlayer(nextContext);
}

// --- METADATA & LIBRARY HELPERS ---
async function handleMetadataCorrection() {
    const { item, context } = state.activeDetailItem;
    const tmdbUrl = prompt(`Enter the correct TMDb URL for "${item.name}":\n(e.g., https://www.themoviedb.org/tv/1668-friends)`);
    if (!tmdbUrl) return;

    const match = tmdbUrl.match(/(movie|tv)\/(\d+)/);
    if (!match) {
        alert("Invalid URL format. Please use a valid TMDb movie or TV show URL.");
        return;
    }
    const [_, type, id] = match;

    const tmdbApiKey = localStorage.getItem(config.TMDB_API_KEY_STORAGE);
    const url = `${config.TMDB_BASE_URL}/${type}/${id}?api_key=${tmdbApiKey}`;
    
    try {
        const response = await fetch(url);
        const data = await response.json();
        const newDetails = {
            poster: data.poster_path ? `${config.TMDB_IMG_URL}${data.poster_path}` : null,
            backdrop: data.backdrop_path ? `${config.TMDB_IMG_URL.replace('w500', 'w1280')}${data.backdrop_path}` : null,
            overview: data.overview,
            release_date: data.release_date || data.first_air_date,
            tmdbId: data.id
        };
        
        // Update the item in the main library
        Object.assign(item, newDetails);
        
        // Save updated library to localStorage
        localStorage.setItem(config.LIBRARY_STORAGE, JSON.stringify(state.library));
        
        // Refresh the details view
        showDetails(item, context);
        // Refresh the main hub to show the new poster
        renderMainHub();

    } catch (error) {
        alert("Failed to fetch data from TMDb. Please check the URL and your API key.");
        console.error("TMDb fetch error:", error);
    }
}

function findLibraryItem(itemToFind) {
    const typeKey = { movie: 'movies', tvSeries: 'tvSeries', filmSeries: 'filmSeries' }[itemToFind.type];
    if (!typeKey) return null;
    // Find by a unique identifier, like the original folder name or a generated ID
    return state.library[typeKey].find(i => i.name === itemToFind.name);
}

function updateContinueWatching(item) {
    let list = state.continueWatching;
    const uniqueId = item.driveId; // Use driveId as a unique key for episodes
    list = list.filter(i => i.driveId !== uniqueId);
    list.unshift(item);
    if (list.length > 15) list.pop();
    state.continueWatching = list;
    localStorage.setItem(config.CONTINUE_WATCHING_STORAGE, JSON.stringify(list));
    renderMainHub();
}

</script>
</body>
</html>
