<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Super Drive Hub v6.1</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
        .poster-card { transition: transform 0.2s ease-in-out; }
        .poster-card:hover { transform: scale(1.05); }
        .carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; padding-bottom: 20px; }
        .carousel > div { scroll-snap-align: start; flex-shrink: 0; }
        .modal-bg { backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">

    <div id="app">
        <div id="loadingScreen" class="min-h-screen flex items-center justify-center p-4">
            <div id="credentialsBox" class="w-full max-w-md bg-gray-800 rounded-2xl shadow-lg p-8 hidden">
                <h1 class="text-3xl font-bold text-center mb-2 text-red-500">Super Drive Hub</h1>
                <p class="text-center text-gray-400 mb-8">Enter your API credentials to begin.</p>
                <div class="space-y-4">
                     <div>
                        <label for="apiKey" class="block text-sm font-medium text-gray-300 mb-1">Google API Key</label>
                        <input type="password" id="apiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="clientId" class="block text-sm font-medium text-gray-300 mb-1">Google Client ID</label>
                        <input type="password" id="clientId" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                    <div>
                        <label for="tmdbApiKey" class="block text-sm font-medium text-gray-300 mb-1">TMDb API Key</label>
                        <input type="password" id="tmdbApiKey" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-3 text-white focus:ring-2 focus:ring-red-500 focus:outline-none">
                    </div>
                </div>
                <button id="authButton" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg mt-8 transition-colors duration-200">Connect to Google Drive</button>
            </div>
             <div id="loadingIndicator" class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-red-500 mx-auto"></div>
                <p id="loadingStatus" class="mt-4 text-lg">Initializing...</p>
            </div>
        </div>

        <div id="mainHub" class="hidden p-4 sm:p-6 md:p-8">
             <div class="flex justify-between items-center mb-6">
                 <h1 class="text-3xl font-bold text-red-500">Browse</h1>
                 <button id="logoutButton" class="text-gray-400 hover:text-white transition-colors duration-200">Logout</button>
            </div>
            <div id="hubContent"></div>
             <div id="scanButtonContainer" class="text-center my-8 hidden">
                <button id="scanButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">Scan Google Drive for Media</button>
                <p class="text-sm text-gray-400 mt-2">Required for first-time setup or to find new content.</p>
            </div>
        </div>

        <div id="detailsModal" class="hidden fixed inset-0 z-40 overflow-y-auto">
            <div class="fixed inset-0 bg-black bg-opacity-75 modal-bg"></div>
            <div id="detailsContent" class="relative min-h-screen"></div>
        </div>
    </div>

<script>
// --- CORE APP LOGIC (VERSION 6.1 - Auth Bug Fix) ---
const config = { DRIVE_API_KEY_STORAGE: 'superdrivehub_v6_google_api_key', DRIVE_CLIENT_ID_STORAGE: 'superdrivehub_v6_google_client_id', TMDB_API_KEY_STORAGE: 'superdrivehub_v6_tmdb_api_key', LIBRARY_STORAGE: 'superdrivehub_v6_library_cache', CONTINUE_WATCHING_STORAGE: 'superdrivehub_v6_continue_watching', TMDB_BASE_URL: 'https://api.themoviedb.org/3', TMDB_IMG_URL: 'https://image.tmdb.org/t/p/w500', MAIN_FOLDER_NAME: 'Entertainment' };
let state = { library: { movies: [], filmSeries: [], tvSeries: [] }, continueWatching: [], activeDetailItem: null, };
const loadingScreen = document.getElementById('loadingScreen'); const credentialsBox = document.getElementById('credentialsBox'); const loadingIndicator = document.getElementById('loadingIndicator'); const loadingStatus = document.getElementById('loadingStatus'); const mainHub = document.getElementById('mainHub'); const hubContent = document.getElementById('hubContent'); const scanButtonContainer = document.getElementById('scanButtonContainer'); const detailsModal = document.getElementById('detailsModal'); const detailsContent = document.getElementById('detailsContent'); const authButton = document.getElementById('authButton'); const logoutButton = document.getElementById('logoutButton'); const scanButton = document.getElementById('scanButton');
function updateStatus(message) { loadingStatus.innerText = message; }

// --- INITIALIZATION ---
window.onload = () => {
    document.getElementById('apiKey').value = localStorage.getItem(config.DRIVE_API_KEY_STORAGE) || '';
    document.getElementById('clientId').value = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE) || '';
    document.getElementById('tmdbApiKey').value = localStorage.getItem(config.TMDB_API_KEY_STORAGE) || '';
    const cachedLibrary = localStorage.getItem(config.LIBRARY_STORAGE);
    if (cachedLibrary) state.library = JSON.parse(cachedLibrary);
    const continueWatchingData = localStorage.getItem(config.CONTINUE_WATCHING_STORAGE);
    if (continueWatchingData) state.continueWatching = JSON.parse(continueWatchingData);
    handleRedirect();
};

function showCredentialsScreen() {
    loadingIndicator.style.display = 'none';
    credentialsBox.style.display = 'block';
}

authButton.addEventListener('click', () => {
    const apiKey = document.getElementById('apiKey').value.trim();
    const clientId = document.getElementById('clientId').value.trim();
    const tmdbApiKey = document.getElementById('tmdbApiKey').value.trim();
    if (apiKey && clientId && tmdbApiKey) {
        localStorage.setItem(config.DRIVE_API_KEY_STORAGE, apiKey);
        localStorage.setItem(config.DRIVE_CLIENT_ID_STORAGE, clientId);
        localStorage.setItem(config.TMDB_API_KEY_STORAGE, tmdbApiKey);
        redirectToGoogleLogin();
    } else { alert('Please enter all three API keys.'); }
});

logoutButton.addEventListener('click', () => {
    Object.values(config).forEach(key => localStorage.removeItem(key));
    Object.keys(localStorage).forEach(key => { if (key.startsWith('track_prefs_')) { localStorage.removeItem(key); } });
    window.location.href = window.location.pathname;
});

// --- GOOGLE API & AUTHENTICATION (REDIRECT FLOW - CORRECTED) ---
function handleRedirect() {
    const fragment = new URLSearchParams(window.location.hash.substring(1));
    const accessToken = fragment.get('access_token');

    if (accessToken) {
        // IMPORTANT FIX: Load the 'client' library BEFORE using gapi.client
        gapi.load('client', () => {
            // Now that the client library is loaded, we can set the token
            gapi.client.setToken({ access_token: accessToken });
            
            // Clean the URL
            window.history.replaceState({}, document.title, window.location.pathname);
            
            // Proceed with initializing the rest of the API
            initializeGapiClient();
        });
    } else {
        if (localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE)) {
            showCredentialsScreen();
        } else {
            showCredentialsScreen();
        }
    }
}

function redirectToGoogleLogin() {
    const CLIENT_ID = localStorage.getItem(config.DRIVE_CLIENT_ID_STORAGE);
    // Use the current URL without any hash as the redirect URI
    const REDIRECT_URI = window.location.href.split('#')[0];
    const SCOPE = 'https://www.googleapis.com/auth/drive.readonly';
    
    const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?` +
        `client_id=${CLIENT_ID}` +
        `&redirect_uri=${encodeURIComponent(REDIRECT_URI)}` +
        `&scope=${SCOPE}` +
        `&response_type=token` +
        `&include_granted_scopes=true`;
        
    window.location.href = authUrl;
}

async function initializeGapiClient() {
    try {
        updateStatus("Initializing Drive API...");
        await gapi.client.init({
            apiKey: localStorage.getItem(config.DRIVE_API_KEY_STORAGE),
            discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'],
        });
        switchToMainHub();
    } catch (error) {
        console.error("GAPI client initialization error:", error);
        alert("Failed to initialize Google Drive API. Please check your API Key.");
        showCredentialsScreen();
    }
}

function switchToMainHub() {
    loadingScreen.style.display = 'none';
    mainHub.style.display = 'block';
    if (state.library.movies.length === 0 && state.library.tvSeries.length === 0 && state.library.filmSeries.length === 0) {
        scanButtonContainer.style.display = 'block';
    } else {
        scanButtonContainer.style.display = 'none';
        renderMainHub();
    }
}

scanButton.addEventListener('click', startLibraryScan);

// --- All other functions (library scanning, UI rendering, etc.) remain identical ---
// Full code included for completeness.
async function startLibraryScan(){scanButtonContainer.style.display='none';loadingScreen.style.display='flex';loadingIndicator.style.display='block';try{updateStatus(`Finding '${config.MAIN_FOLDER_NAME}' folder...`);const t=await findFolderId(config.MAIN_FOLDER_NAME);if(!t){updateStatus(`Error: Main folder '${config.MAIN_FOLDER_NAME}' not found.`);setTimeout(()=>{switchToMainHub();scanButtonContainer.style.display='block'},3e3);return}updateStatus("Scanning library structure...");const e=await listItemsInFolder(t,"mimeType='application/vnd.google-apps.folder'");const o={movies:[],filmSeries:[],tvSeries:[]};for(const n of e)if("movies"===n.name.toLowerCase()){updateStatus("Processing Movies...");o.movies=await processMovieFolder(n.id)}else if("film series"===n.name.toLowerCase()){updateStatus("Processing Film Series...");o.filmSeries=await processSeriesFolder(n.id,"filmSeries")}else if("series"===n.name.toLowerCase()){updateStatus("Processing TV Series...");o.tvSeries=await processSeriesFolder(n.id,"tvSeries")}state.library=o;localStorage.setItem(config.LIBRARY_STORAGE,JSON.stringify(state.library));switchToMainHub()}catch(r){console.error("Library Scan Failed:",r);updateStatus("An error occurred during the scan. Please check console.");setTimeout(()=>{switchToMainHub();scanButtonContainer.style.display='block'},3e3)}}
async function findFolderId(t){const e=await gapi.client.drive.files.list({q:`mimeType='application/vnd.google-apps.folder' and name='${t}' and trashed=false`,fields:"files(id)",pageSize:1});return e.result.files?.[0]?.id}
async function listItemsInFolder(t,e=""){let o=[];let n=null;const r=`'${t}' in parents and trashed=false`,i=e?`${r} and (${e})`:r;do{const l=await gapi.client.drive.files.list({q:i,fields:"nextPageToken, files(id, name)",pageSize:200,pageToken:n});o.push(...l.result.files);n=l.result.nextPageToken}while(n);return o}
async function processMovieFolder(t){const e=await listItemsInFolder(t,"mimeType='application/vnd.google-apps.folder'");const o=[];for(const n of e){const r=await listItemsInFolder(n.id,"mimeType contains 'video/'");if(r.length>0){const i=await getTMDbData(n.name,"movie");o.push({driveId:r[0].id,name:n.name,type:"movie",...i})}}return o}
async function processSeriesFolder(t,e){const o=await listItemsInFolder(t,"mimeType='application/vnd.google-apps.folder'");const n=[];for(const r of o){updateStatus(`Processing: ${r.name}`);const i=await getTMDbData(r.name,"tvSeries"===e?"tv":"movie");const l={name:r.name,type:e,...i,seasons:[]};if("tvSeries"===e){const s=await listItemsInFolder(r.id,"mimeType='application/vnd.google-apps.folder'");s.sort((a,b)=>a.name.localeCompare(b.name,void 0,{numeric:!0}));for(const c of s){const d=await listItemsInFolder(c.id,"mimeType contains 'video/'");d.sort((a,b)=>a.name.localeCompare(b.name,void 0,{numeric:!0}));l.seasons.push({name:c.name,episodes:d.map(a=>({name:a.name,driveId:a.id}))})}}else{const p=await listItemsInFolder(r.id,"mimeType='application/vnd.google-apps.folder'");p.sort((a,b)=>a.name.localeCompare(b.name,void 0,{numeric:!0}));const m=[];for(const u of p){const f=await listItemsInFolder(u.id,"mimeType contains 'video/'");f.length>0&&m.push({name:u.name,driveId:f[0].id})}l.seasons.push({name:"Movies",episodes:m})}n.push(l)}return n}
async function getTMDbData(t,e){const o=localStorage.getItem(config.TMDB_API_KEY_STORAGE),n=t.replace(/\(.*\)|\[.*\]/g,"").trim(),r=`${config.TMDB_BASE_URL}/search/${e}?api_key=${o}&query=${encodeURIComponent(n)}`;try{const i=await fetch(r),l=await i.json(),s=l.results?.[0];if(s)return{poster:s.poster_path?`${config.TMDB_IMG_URL}${s.poster_path}`:null,backdrop:s.backdrop_path?`${config.TMDB_IMG_URL.replace("w500","w1280")}${s.backdrop_path}`:null,overview:s.overview,release_date:s.release_date||s.first_air_date,tmdbId:s.id}}catch(c){console.error(`TMDb fetch failed for ${t}:`,c)}return{poster:null,backdrop:null,overview:"No description available.",release_date:"",tmdbId:null}}
function renderMainHub(){hubContent.innerHTML="";state.continueWatching.length>0&&hubContent.appendChild(createCarousel("Continue Watching",state.continueWatching,"continue"));state.library.tvSeries.length>0&&hubContent.appendChild(createCarousel("TV Shows",state.library.tvSeries,"tvSeries"));state.library.movies.length>0&&hubContent.appendChild(createCarousel("Movies",state.library.movies,"movie"));state.library.filmSeries.length>0&&hubContent.appendChild(createCarousel("Film Series",state.library.filmSeries,"filmSeries"))}
function createCarousel(t,e,o){const n=document.createElement("div");n.className="mb-8";n.innerHTML=`<h2 class="text-2xl font-bold mb-4">${t}</h2>`;const r=document.createElement("div");r.className="carousel";e.forEach(i=>{const l=i.poster||"https://placehold.co/500x750/1f2937/374151?text=No+Poster",s=document.createElement("div");s.className="poster-card w-40 sm:w-48 mr-4 cursor-pointer";s.innerHTML=`<img src="${l}" class="rounded-lg w-full aspect-[2/3] object-cover bg-gray-800"><p class="mt-2 text-sm truncate">${i.name}</p>`;const c=findLibraryItem(i)||i;s.addEventListener("click",()=>{o==="continue"?openPlayer(c):showDetails(c,{type:o})});r.appendChild(s)});n.appendChild(r);return n}
function showDetails(t,e){state.activeDetailItem={item:t,context:e};const o=t.release_date?`(${t.release_date.substring(0,4)})`:"",n=t.backdrop||"";let r=`
        <div class="absolute top-4 left-4 z-10 flex space-x-2">
            <button onclick="closeDetails()" class="bg-gray-800/50 hover:bg-gray-700/70 py-2 px-4 rounded-lg">&larr; Back</button>
            <button onclick="handleMetadataCorrection()" class="bg-blue-600/80 hover:bg-blue-500/90 py-2 px-4 rounded-lg">Fix Match</button>
        </div>
        <div class="h-[60vh] w-full bg-cover bg-center" style="background-image: linear-gradient(to top, #111827 10%, transparent 50%), url('${n}');"></div>
        <div class="p-4 sm:p-8 -mt-32 relative">
            <h1 class="text-4xl font-bold">${t.name} ${o}</h1>
            <p class="mt-4 max-w-2xl text-gray-300">${t.overview}</p>`;if("movie"===t.type)r+=`<button onclick='openPlayer(${JSON.stringify(t)})' class="mt-6 bg-red-600 hover:bg-red-700 px-8 py-3 rounded-lg font-semibold">Play Movie</button>`;else t.seasons.forEach((i,l)=>{r+=`<h3 class="text-2xl font-bold mt-8 mb-4">${i.name}</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;i.episodes.forEach((s,c)=>{const d={...t,driveId:s.driveId,name:s.name,seasonIndex:l,episodeIndex:c};r+=`<div onclick='openPlayer(${JSON.stringify(d)})' class="bg-gray-800 p-4 rounded-lg cursor-pointer hover:bg-gray-700"><p class="font-semibold truncate">${s.name}</p></div>`});r+="</div>"});r+="</div>";detailsContent.innerHTML=r;detailsModal.style.display="block"}
function closeDetails(){detailsModal.style.display="none";detailsContent.innerHTML="";state.activeDetailItem=null}
function openPlayer(t){updateContinueWatching(t);const e=new URLSearchParams;e.set("driveId",t.driveId);e.set("title",t.name);if("movie"!==t.type){e.set("seriesId",t.tmdbId);const o=findLibraryItem(t);if(o&&o.seasons){const n=o.seasons[t.seasonIndex];if(t.episodeIndex<n.episodes.length-1){const r=n.episodes[t.episodeIndex+1];e.set("nextDriveId",r.driveId);e.set("nextTitle",r.name)}}}window.open(`player.html?${e.toString()}`,"_blank")}
async function handleMetadataCorrection(){const{item:t,context:e}=state.activeDetailItem,o=prompt(`Enter the correct TMDb URL for "${t.name}":\n(e.g., https://www.themoviedb.org/tv/1668-friends)`);if(!o)return;const n=o.match(/(movie|tv)\/(\d+)/);if(!n){alert("Invalid URL format. Please use a valid TMDb movie or TV show URL.");return}const[_,r,i]=n,l=localStorage.getItem(config.TMDB_API_KEY_STORAGE),s=`${config.TMDB_BASE_URL}/${r}/${i}?api_key=${l}`;try{const c=await fetch(s),d=await c.json(),p={poster:d.poster_path?`${config.TMDB_IMG_URL}${d.poster_path}`:null,backdrop:d.backdrop_path?`${config.TMDB_IMG_URL.replace("w500","w1280")}${d.backdrop_path}`:null,overview:d.overview,release_date:d.release_date||d.first_air_date,tmdbId:d.id};Object.assign(t,p);localStorage.setItem(config.LIBRARY_STORAGE,JSON.stringify(state.library));showDetails(t,e);renderMainHub()}catch(m){alert("Failed to fetch data from TMDb. Please check the URL and your API key.");console.error("TMDb fetch error:",m)}}
function findLibraryItem(t){if(!t||!t.type)return null;const e={movie:"movies",tvSeries:"tvSeries",filmSeries:"filmSeries"},o=e[t.type];if(!o)return null;return state.library[o]?.find(n=>n.name===t.name)}
function updateContinueWatching(t){let e=state.continueWatching;const o=t.driveId;e=e.filter(n=>n.driveId!==o);e.unshift(t);e.length>15&&e.pop();state.continueWatching=e;localStorage.setItem(config.CONTINUE_WATCHING_STORAGE,JSON.stringify(e));renderMainHub()}
</script>
</body>
</html>
